<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Вход в Reflex AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            min-height: 100vh;
            margin: 0;
            padding: 0;
            /* Градиентный анимированный фон с фиолетовыми оттенками */
            background: linear-gradient(120deg, #181818 0%, #232323 40%, #8f5cff 100%);
            background-size: 200% 200%;
            animation: gradientMove 8s ease-in-out infinite;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .auth-box {
            background: rgba(35,35,35,0.92);
            border-radius: 18px;
            box-shadow: 0 8px 32px 0 #000a, 0 1.5px 8px #8f5cff80;
            padding: 40px 32px;
            min-width: 340px;
            max-width: 95vw;
            backdrop-filter: blur(6px);
            border: 1.5px solid #8f5cff40;
            transition: box-shadow 0.3s;
        }
        .auth-box:hover {
            box-shadow: 0 12px 40px 0 #000c, 0 2px 12px #b39cffb0;
        }
        .auth-box h2 {
            margin-bottom: 22px;
            font-weight: 700;
            letter-spacing: 1px;
            text-align: center;
            background: linear-gradient(90deg, #8f5cff 30%, #fff 70%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .auth-box form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .auth-box input {
            padding: 12px;
            border-radius: 7px;
            border: 1.5px solid #444;
            background: rgba(24,24,24,0.92);
            color: #fff;
            font-size: 16px;
            transition: border 0.2s, box-shadow 0.2s;
            outline: none;
        }
        .auth-box input:focus {
            border: 1.5px solid #8f5cff;
            box-shadow: 0 0 0 2px #8f5cff40;
        }
        .auth-box button {
            padding: 13px;
            background: linear-gradient(90deg, #8f5cff 60%, #b39cff 100%);
            color: #fff;
            border: none;
            border-radius: 7px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px #8f5cff40;
            transition: background 0.3s, box-shadow 0.2s;
        }
        .auth-box button:hover {
            background: linear-gradient(90deg, #b39cff 0%, #8f5cff 100%);
            box-shadow: 0 4px 16px #8f5cff80;
        }
        .auth-box .switch-link {
            color: #8f5cff;
            cursor: pointer;
            text-decoration: underline;
            font-weight: 500;
            transition: color 0.2s;
        }
        .auth-box .switch-link:hover {
            color: #b39cff;
        }
        .auth-box .feedback {
            color: #f55;
            min-height: 18px;
            font-size: 13px;
            margin-top: 2px;
            text-align: center;
        }
        /* Анимация появления формы */
        .auth-box {
            opacity: 0;
            transform: translateY(30px) scale(0.98);
            animation: fadeInUp 0.8s cubic-bezier(.23,1.01,.32,1) 0.2s forwards;
        }
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="auth-box">
        <h2 id="authTitle">Вход</h2>
        <form id="authForm" autocomplete="off">
            <input type="text" name="username" placeholder="Имя пользователя" required>
            <input type="password" name="password" placeholder="Пароль" required>
            <input type="text" name="displayName" placeholder="Отображаемое имя" style="display:none;">
            <button type="submit">Войти</button>
        </form>
        <div class="feedback" id="authFeedback"></div>
        <div style="font-size:13px;margin-top:10px;">
            Нет аккаунта? <span class="switch-link" id="switchToRegister">Регистрация</span>
        </div>
    </div>
    <script>
        // --- auth.html логика ---
        let isRegister = false;
        const form = document.getElementById('authForm');
        const feedback = document.getElementById('authFeedback');
        const title = document.getElementById('authTitle');
        const displayNameInput = form.querySelector('input[name="displayName"]');
        const switchLink = document.getElementById('switchToRegister');

        function setMode(register) {
            isRegister = register;
            if (register) {
                title.textContent = 'Регистрация';
                displayNameInput.style.display = '';
                form.querySelector('button').textContent = 'Зарегистрироваться';
                switchLink.textContent = 'Войти';
                switchLink.previousSibling.textContent = 'Есть аккаунт? ';
            } else {
                title.textContent = 'Вход';
                displayNameInput.style.display = 'none';
                form.querySelector('button').textContent = 'Войти';
                switchLink.textContent = 'Регистрация';
                switchLink.previousSibling.textContent = 'Нет аккаунта? ';
            }
            feedback.textContent = '';
        }

        switchLink.onclick = () => setMode(!isRegister);

        form.onsubmit = async (e) => {
            e.preventDefault();
            feedback.textContent = '';
            const data = Object.fromEntries(new FormData(form).entries());
            let url = isRegister ? '/api/register' : '/api/login';
            try {
                let resp = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                let res = await resp.json();
                if (!resp.ok) {
                    if (res.error && res.error.toLowerCase().includes('подтверждения')) {
                        feedback.textContent = 'Ожидайте подтверждения регистрации...';
                        form.querySelectorAll('input,button').forEach(el => el.disabled = true);
                        // Периодически пробуем войти автоматически
                        let interval = setInterval(async () => {
                            let checkResp = await fetch('/api/login', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ username: data.username, password: data.password })
                            });
                            let checkRes = await checkResp.json();
                            if (checkResp.ok && checkRes.token) {
                                clearInterval(interval);
                                feedback.textContent = 'Аккаунт подтверждён, вход...';
                                localStorage.setItem('authToken', checkRes.token);
                                setTimeout(() => { window.location.href = 'index.html'; }, 800);
                            }
                        }, 5000);
                        return;
                    }
                    throw new Error(res.error || 'Ошибка');
                }
                if (isRegister) {
                    feedback.textContent = 'Ожидайте подтверждения регистрации...';
                    form.querySelectorAll('input,button').forEach(el => el.disabled = true);
                    let interval = setInterval(async () => {
                        let checkResp = await fetch('/api/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username: data.username, password: data.password })
                        });
                        let checkRes = await checkResp.json();
                        if (checkResp.ok && checkRes.token) {
                            clearInterval(interval);
                            feedback.textContent = 'Аккаунт подтверждён, вход...';
                            localStorage.setItem('authToken', checkRes.token);
                            setTimeout(() => { window.location.href = 'index.html'; }, 800);
                        }
                    }, 5000);
                    return;
                }
                // Успешный вход
                localStorage.setItem('authToken', res.token);
                window.location.href = 'index.html';
            } catch (err) {
                feedback.textContent = err.message || 'Ошибка';
            }
        };

        // Если уже авторизован — редирект на главную
        if (localStorage.getItem('authToken')) {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
